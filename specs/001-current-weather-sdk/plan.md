# Implementation Plan: Open Meteo Current Weather SDK

**Branch**: `001-current-weather-sdk` | **Date**: 2025-12-28 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/001-current-weather-sdk/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command. All NEEDS CLARIFICATION markers have been resolved through research and design phases.

## Summary

Build a Go SDK that wraps the Open Meteo Current Weather API, providing a simple, thread-safe interface for fetching all 15 current weather parameters (temperature, humidity, wind, precipitation, etc.) using only latitude and longitude coordinates. The SDK will handle HTTP communication, JSON parsing, error classification, and concurrency control (max 10 simultaneous requests) while following Effective Go standards. All values returned in metric units only. Zero external dependencies (stdlib only).

## Technical Context

**Language/Version**: Go 1.25.5 (Latest Stable)  
**Primary Dependencies**: None (stdlib only: `net/http`, `encoding/json`, `testing`, `httptest`)  
**Storage**: N/A (stateless HTTP client)  
**Testing**: Go stdlib `testing` package with `httptest` for mocking  
**Target Platform**: Cross-platform (Linux, macOS, Windows) - library package  
**Project Type**: Single package library (flat structure at repository root)  
**Performance Goals**: <500ms p95 latency for API requests, support 10 concurrent requests per client instance  
**Constraints**: 
- 10-second default timeout for HTTP requests
- Max 10 concurrent requests per client (enforced via semaphore)
- No automatic retries (application-level responsibility)
- Metric units only (no unit conversion)
**Scale/Scope**: Single-purpose SDK (~500-800 LOC), targeting Go developers needing weather data integration

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### ✅ I. Code Quality (Effective Go)

**Status**: PASS

- All code will follow Effective Go guidelines
- `gofmt` enforced via CI (golangci-lint)
- Public APIs documented with godoc-compliant comments
- Error handling follows Go 1.13+ error wrapping patterns
- Concurrency uses idiomatic patterns (channels, contexts)

### ✅ II. Testing Standards

**Status**: PASS

- Unit tests colocated with source code (`*_test.go` files)
- Target: 80% minimum coverage (enforced in CI)
- Integration tests for Open Meteo API (optional, build tag `integration`)
- Tests are deterministic (use `httptest` for mocking)
- Fast execution (<1s for unit tests)

### ✅ III. User Experience Consistency

**Status**: PASS (N/A for library)

- Library API, not CLI - UX principle applies to API design
- Error messages are actionable and distinguish user vs system errors
- Three error types: Validation, Network, API
- Human-readable error descriptions
- Consistent naming conventions across all exported types

### ✅ IV. Performance Requirements

**Status**: PASS

- Efficient resource usage: connection pooling via reused `http.Client`
- Timeouts enforced: 10s default, configurable
- Performance-critical path: HTTP request (I/O bound, minimal CPU)
- Concurrency control prevents resource exhaustion (10 request limit)
- Value types preferred over pointers to reduce GC pressure

### ✅ V. Documentation Standards

**Status**: PASS

- README.md will be created/updated with:
  - Project description and purpose
  - Installation instructions
  - Quick start guide
  - Usage examples
  - Contributing guidelines
- All exported symbols documented with godoc comments
- [quickstart.md](quickstart.md) provides comprehensive usage examples

### ✅ VI. Release & Build Standards

**Status**: PASS

- GitHub Actions CI workflow configured
  - Lint: golangci-lint-action v9.2.0
  - Test: go test with race detector
  - Coverage: 80% enforcement
- Makefile for local development (test, lint, coverage, clean)
- SemVer versioning via git tags
- Initial version: v0.1.0 (pre-1.0 beta)
- Cross-compilation handled by Go toolchain (GOOS/GOARCH)

**Constitution Compliance Summary**: All 6 core principles satisfied. No violations requiring justification.

## Project Structure

### Documentation (this feature)

```text
specs/001-current-weather-sdk/
├── plan.md                  # This file (/speckit.plan output)
├── spec.md                  # Feature specification
├── research.md              # Phase 0: Technical research findings
├── data-model.md            # Phase 1: Entity definitions
├── quickstart.md            # Phase 1: Usage guide
├── contracts/               # Phase 1: API contracts
│   ├── api.md              # SDK public API contract
│   └── open-meteo-api.md   # External API contract
├── checklists/              # Validation artifacts
│   └── requirements.md     # Specification quality checklist
└── tasks.md                 # Phase 2: NOT YET CREATED (run /speckit.tasks)
```

### Source Code (repository root)

```text
open-meteo-weather-sdk/
├── go.mod                   # Go module definition
├── go.sum                   # Dependency checksums (empty - no deps)
├── README.md                # Project documentation
├── LICENSE                  # Project license
├── Makefile                 # Local development tasks
├── .gitignore              # Git ignore patterns
│
├── .github/
│   ├── workflows/
│   │   └── ci.yml          # GitHub Actions CI pipeline
│   └── agents/
│       └── copilot-instructions.md  # AI agent context
│
├── .specify/                # Speckit framework (existing)
│
├── client.go                # Main SDK client implementation
├── client_test.go           # Client unit tests
├── weather.go               # CurrentWeather type definition
├── weather_test.go          # Weather type tests
├── errors.go                # Error types and handling
├── errors_test.go           # Error handling tests
├── options.go               # Configuration options (functional pattern)
├── options_test.go          # Options tests
│
└── examples/
    └── basic/
        └── main.go          # Basic usage example
```

**Structure Decision**: 

Selected **flat package structure** at repository root following Go conventions for single-purpose libraries. Rationale:

1. **Simplicity**: Single package SDK doesn't need nested directories
2. **Go Idioms**: Matches standard library pattern (e.g., `net/http`, `encoding/json`)
3. **Import Path**: `import "github.com/yourusername/open-meteo-weather-sdk"` is clean
4. **Discoverability**: All source files visible at root level
5. **Test Colocation**: `*_test.go` files alongside source per constitution

Alternative rejected: `pkg/` subdirectory unnecessary for single-package library (adds nesting without value).

## Complexity Tracking

> **Not applicable** - All constitution principles satisfied with no violations.

No complexity justification required. The implementation follows straightforward patterns:
- Single package library (no multi-project complexity)
- Standard library only (no external dependencies)
- Simple flat structure (no layered architecture needed)
- Direct HTTP client usage (no repository pattern or abstraction layers)

The design is as simple as possible while meeting all requirements.

---

## Phase 0: Research & Discovery

**Status**: ✅ COMPLETE

**Output**: [research.md](research.md)

**Key Findings**:
1. Open Meteo API endpoint and response structure documented
2. Go HTTP client best practices established (stdlib `net/http`)
3. Error handling pattern defined (typed errors with unwrapping)
4. Concurrency control via buffered channel semaphore
5. Testing strategy with `httptest` for mocking
6. CI/CD configuration with GitHub Actions and golangci-lint
7. Makefile targets for local development
8. Zero external dependencies - stdlib only

**All NEEDS CLARIFICATION markers resolved.**

---

## Phase 1: Design & Contracts

**Status**: ✅ COMPLETE

### Data Model

**Output**: [data-model.md](data-model.md)

**Core Entities**:
1. **Client** - Main SDK entry point with HTTP client and concurrency control
2. **CurrentWeather** - 15 weather parameters with coordinates and timestamp
3. **Error** - Typed error with classification (Validation/Network/API)
4. **ErrorType** - Error category enumeration
5. **Option** - Functional options for client configuration

**Key Design Decisions**:
- Value types (no pointers) for simplicity and reduced GC pressure
- Zero values for null API responses (documented behavior)
- Thread-safe client for concurrent goroutine access
- Immutable data structures after creation

### API Contracts

**Output**: [contracts/api.md](contracts/api.md), [contracts/open-meteo-api.md](contracts/open-meteo-api.md)

**SDK Public API**:
- `NewClient(opts ...Option) *Client` - Constructor with functional options
- `GetCurrentWeather(ctx, lat, lon) (*CurrentWeather, error)` - Primary method
- Configuration options: `WithTimeout`, `WithHTTPClient`, `WithBaseURL`
- Typed errors for programmatic error handling

**External API Integration**:
- Endpoint: `GET https://api.open-meteo.com/v1/forecast`
- Parameters: latitude, longitude, current weather params, metric units
- Response: JSON with 15+ weather fields
- Error handling for 4xx/5xx status codes

### Quick Start Guide

**Output**: [quickstart.md](quickstart.md)

**Coverage**:
- Installation instructions
- Basic usage examples
- Custom configuration patterns
- Error handling strategies
- Concurrent request patterns
- Testing with mock servers
- Best practices and troubleshooting

### Agent Context Update

**Output**: [.github/agents/copilot-instructions.md](../../.github/agents/copilot-instructions.md)

**Status**: ✅ Created from template

Agent context file initialized with technology stack and project structure for AI-assisted development.

---

## Phase 2: Task Breakdown

**Status**: ⏳ PENDING

**Command**: Run `/speckit.tasks` to generate [tasks.md](tasks.md)

Tasks will be organized by user story (P1, P2, P3) following the specification:
- **P1**: Fetch Current Weather by Coordinates (MVP)
- **P2**: Handle Errors Gracefully
- **P3**: Configure Request Options

Each story independently testable and deliverable.

---

## Implementation Notes

### File Organization

**Core Implementation** (4 files, ~600 LOC):
- `client.go` - HTTP client, concurrency control, main method (~200 LOC)
- `weather.go` - Data types, JSON unmarshaling (~150 LOC)
- `errors.go` - Error types and helpers (~100 LOC)
- `options.go` - Configuration options (~150 LOC)

**Tests** (4 files, ~800 LOC):
- Colocated `*_test.go` files with 80%+ coverage
- Unit tests with `httptest` mocking
- Table-driven tests for validation and edge cases

**Infrastructure**:
- `Makefile` - Development tasks (~50 LOC)
- `.github/workflows/ci.yml` - CI pipeline (~80 LOC)
- `go.mod` - Module definition (minimal)
- `README.md` - Documentation (~200 LOC)

### Testing Strategy

**Unit Tests** (fast, deterministic):
- Mock HTTP responses using `httptest.Server`
- Test coordinate validation
- Test error type classification
- Test concurrency limit enforcement
- Test JSON parsing with null values

**Integration Tests** (optional, build tag):
- Real API calls (marked with `//go:build integration`)
- Verify actual API contract
- Rate limit: run sparingly to avoid quota usage

**Coverage Target**: 80% minimum (enforced in CI)

### CI/CD Pipeline

**GitHub Actions Workflow** (`.github/workflows/ci.yml`):

```yaml
name: CI
on: [push, pull_request]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
      - uses: golangci/golangci-lint-action@v9
  
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
      - run: go test -v -race -coverprofile=coverage.out ./...
      - run: |
          coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          if (( $(echo "$coverage < 80" | bc -l) )); then exit 1; fi
```

**Triggers**: Push to `main`, all pull requests

**Quality Gates**:
1. Linting passes (golangci-lint)
2. Tests pass with race detector
3. Coverage ≥ 80%

### Development Workflow

**Local Commands** (Makefile):
```bash
make test      # Run tests with race detector
make lint      # Run golangci-lint
make coverage  # Generate coverage report (HTML + check 80%)
make clean     # Remove coverage artifacts
```

**Before Committing**:
1. Run `make lint` - ensure code style compliance
2. Run `make coverage` - verify 80% coverage
3. Run tests - ensure all pass
4. Update README.md if API changes

### Versioning Strategy

**Initial Release**: v0.1.0 (beta)

**Pre-1.0 Period**:
- API may change (document in CHANGELOG)
- Gather feedback from early adopters
- Iterate on design based on usage patterns

**1.0.0 Release**:
- API stability commitment
- Semantic versioning strictly followed
- Breaking changes require major version bump

### Dependencies Audit

**External Dependencies**: None

**Stdlib Dependencies**:
- `net/http` - HTTP client
- `encoding/json` - JSON marshaling
- `context` - Cancellation and timeouts
- `time` - Timestamp handling
- `errors` - Error wrapping
- `testing` - Unit tests
- `net/http/httptest` - HTTP mocking

**Rationale**: All required functionality available in stdlib. No supply chain risk. Fast compilation. Easy auditing.

### Performance Benchmarks

**Deferred to post-MVP**:
- Benchmark HTTP request overhead
- Benchmark JSON unmarshaling performance
- Benchmark concurrent request throughput
- Profile memory allocations

**Expected Performance** (based on research):
- Latency: 100-500ms (network-bound)
- Throughput: Limited by Open Meteo API, not SDK
- Memory: <1MB per client instance

### Security Considerations

**Input Validation**:
- Coordinates validated before API call
- Prevents injection attacks via URL construction

**TLS**:
- HTTPS enforced (base URL hardcoded to `https://`)
- Prevents downgrade attacks

**Timeouts**:
- Default 10s timeout prevents resource exhaustion
- Configurable for different network conditions

**No Secrets**:
- No API keys required
- No credential storage

**Supply Chain**:
- Zero external dependencies
- Only Go stdlib (vetted by Go team)

### Migration Path

**From v0.x to v1.0**:
- Document any API changes in CHANGELOG
- Provide migration guide if breaking changes
- Deprecate old APIs before removal (where possible)

**Future Enhancements** (post-MVP, out of scope):
- Additional weather endpoints (hourly, daily, historical)
- Caching layer
- Rate limiting helpers
- Retry strategies (application-level plugin)

---

## Next Steps

1. **Run `/speckit.tasks`** to generate detailed task breakdown
2. **Review tasks** and adjust priorities if needed
3. **Begin implementation** following task order (P1 → P2 → P3)
4. **Update README.md** after implementation complete
5. **Tag release** v0.1.0 when MVP ready

---

## References

- **Feature Spec**: [spec.md](spec.md)
- **Research**: [research.md](research.md)
- **Data Model**: [data-model.md](data-model.md)
- **API Contract**: [contracts/api.md](contracts/api.md)
- **External API**: [contracts/open-meteo-api.md](contracts/open-meteo-api.md)
- **Quick Start**: [quickstart.md](quickstart.md)
- **Constitution**: [../../.specify/memory/constitution.md](../../.specify/memory/constitution.md)
- **Open Meteo Docs**: https://open-meteo.com/en/docs
- **Effective Go**: https://go.dev/doc/effective_go
